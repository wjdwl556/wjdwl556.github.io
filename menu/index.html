<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>평강교회 바자회 메뉴</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link
      href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js"
      integrity="sha512-1/RvZTcCDEUjY/CypiMz+iqqtaoQfAITmNSJY17Myp4Ms5mdxPS5UV7iOfdZoxcGhzFbOm6sntTKJppjvuhg4g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Black+And+White+Picture&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css"
      integrity="sha512-SbiR/eusphKoMVVXysTKG/7VseWii+Y3FdHrt0EpKgpToZeemhqHeZeLWLhJutz/2ut2Vw1uQEj2MbRF+TVBUA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sunflower:wght@300;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
      integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <link href="/css/styles.css" rel="stylesheet" />
    <link href="/css/project.css" rel="stylesheet" />
    <link href="/css/menu.css" rel="stylesheet" />
  </head>
  <body class="main_div">
    <!-- End footer -->
    <div class="container main_container">
      <div
        class="coffee_logo d-flex align-items-center justify-content-between "
      >
        <div class="cafe_text">CAFE</div>
        <img style="width: 26%" src="/images/menu/cafe/logo_.png" alt="" />
        <div class="cafe_text">MENU</div>
      </div>
      <div class="menu_list">
        <div class="d-flex align-items-center  mb-3 justify-content-between menu_tab_bar">
          <div data-type="drink" class="text-center btn-light btn menu_tab_click py-3 w-50 pointer" style="">
            DRINK
          </div>
          <div data-type="bread" class="text-center btn-light btn menu_tab_click py-3 w-50 pointer">
            DESSERT
          </div>
        </div>
    
        <div class="row text-center menu_draw"></div>
      </div>
      <div class="order_list">
        <div class="container row pt-2" style="max-width: 950px">
          <div class="order_wrap"></div>
          <div
            class="btn_wrap my-2 d-flex align-items-center justify-content-end px-0"
          >
            <div class="me-3">
              총금액:<span class="total_price ms-2">0</span>원
            </div>
            <div class="btn order_btn btn-sm p-1 px-3">주문</div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/scripts.min.js"></script>

    <link
      rel="stylesheet"
      type="text/css"
      href="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.css"
      integrity="sha512-6lLUdeQ5uheMFbWm3CP271l14RsX1xtx+J5x2yeIDkkiBpeVTNhTqijME7GgRKKi6hCqovwCoBTlRBEC20M8Mg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <script
      type="text/javascript"
      src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"
    ></script>
    <script src="js/project.js"></script>
  </body>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      push,
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDg0M1zak7ZdIBp6uoFgiSwlyfdXoo5zvk",
      authDomain: "menu-5ecc1.firebaseapp.com",
      projectId: "menu-5ecc1",
      storageBucket: "menu-5ecc1.appspot.com",
      messagingSenderId: "411891444872",
      appId: "1:411891444872:web:d3bc08ce89d89ee3ee433d",
      measurementId: "G-9KG4DS84TQ",
      databaseURL: "https://menu-5ecc1-default-rtdb.firebaseio.com/",
    };


    let cafeMenu = 'drink'

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase(app);

    let urlParams = new URLSearchParams(window.location.search);

    // 각 파라미터 값 가져오기
    let typeValue = urlParams.get("type"); //type

    let menus = {
      menu1: {
        name: "menu1",
        items: [
          {
            name: "메뉴1-1",
            money: "3000",
          },
          {
            name: "메뉴1-2",
            money: "1000",
          },
          {
            name: "메뉴1-3",
            money: "2000",
          },
          {
            name: "메뉴1-4",
            money: "1000",
          },
          {
            name: "메뉴1-5",
            money: "1500",
          },
          {
            name: "메뉴1-6",
            money: "1300",
          },
        ],
      },
      menu2: {
        name: "menu2",
        items: [
          {
            name: "메뉴2-1",
            money: "3000",
          },
          {
            name: "메뉴2-2",
            money: "1000",
          },
          {
            name: "메뉴2-3",
            money: "2000",
          },
          {
            name: "메뉴2-4",
            money: "1000",
          },
          {
            name: "메뉴2-5",
            money: "1500",
          },
          {
            name: "메뉴2-6",
            money: "1300",
          },
        ],
      },
      // 필요하다면 더 많은 메뉴 추가 가능
      drink: {
        name: "drink",
        items: [
          {
            name: "아이스아메리카노",
            money: "2000",
            type: "hot",
          },
          {
            name: "아메리카노(HOT)",
            money: "1500",
            type: "hot",
          },
          {
            name: "초당 옥수수 커피",
            money: "4000",
            type: "limited",
          },
          {
            name: "초코 라떼",
            money: "3500",
          },
          {
            name: "자스민 자몽에이드",
            money: "3500",
          },
          {
            name: "패션 후르츠 에이드",
            money: "3500",
          },
          {
            name:"자스민 자몽차(HOT)",
            money:"3000",
          },
          {
            name:"패션 후르츠차(HOT)",
            money:"3000"
          }
        ],
      },
      bread: {
        name: "bread",
        items: [
          {
            name: "휘낭시에 (플레인)",
            money: "2300",
          },
          {
            name: "휘낭시에 (초코 솔트)",
            money: "2800",
            type: "hot",
          },
          {
            name: "휘낭시에 (얼그레이)",
            money: "2800",
            type: "hot",
          },
          {
            name: "휘낭시에 (피스타치오)",
            money: "2800",
          },
          {
            name: "마들렌 (플레인)",
            money: "2300",
          },
          {
            name: "마들렌 (초코)",
            money: "2800",
          },
          {
            name: "마들렌 (말차)",
            money: "2800",
          },
          {
            name: "마들렌 (레몬)",
            money: "2800",
          },
          {
            name:"화이트 초코 크렌베리 쿠키",
            money:"1500"
          },
      
        ],
      },
    };


    draMenu();
    function draMenu(){
      let selectedMenu = menus[cafeMenu];
        console.log("selectedMenu", selectedMenu.name);
        $(".menu_draw").html('');
        if (selectedMenu.name != "cafe") {
          $(".cafe_text").addClass("d-none");
          $(".coffee_logo").removeClass("justify-content-between");
          $(".coffee_logo").addClass("justify-content-center");
        }

        // <img class="w-100 h-100 mb-2" src="/images/menu/${
        //               selectedMenu.name
        //             }/${v.name}.jpg" alt="" />

        $.each(selectedMenu.items, function (i, v) {
          let typeStr = ``;

          if (v.type) {
            if (v.type == "limited") {
              typeStr = `
              <div class="badge-container">
                <div class="badge_ animate__flip animate__infinite infinite">
                  <img class="badge-img front" src="/images/menu/cafe/limited_offer.png" />
                  <img class="badge-img back" src="/images/menu/cafe/limited_offer.png" />
                </div>
              </div>
              `;
            }
          }
          console.log('cc', v.name);
          
          
          
          let str = ''
          str = `
            <div class="col-4 mb-2 menu_div">
                ${typeStr}
                <div class="img-container" style="border-radius:20px; background:white;">
                  <img class="w-100 h-100 mb-2" src="/images/menu/cafe/${v.name}.jpg" alt="" />
                </div>
                <div class="name">${v.name}</div>
                <div class="text-end money f-small">${addComma(v.money * 1)}</div>
            </div>
          `;
          

          $(".menu_draw").append(str);
        });
    }

    

    $(document).on("click", ".menu_div", function () {
      // name과 money 값을 가져오기
      var menuName = $(this).find(".name").text();
      var menuMoney = $(this).find(".money").text();
      // money에서 쉼표를 제거하고 숫자만 추출
      var cleanMoney = menuMoney.replace(/,/g, "");
      // 결과 출력 (예: 콘솔에 출력)
      console.log("메뉴 이름: " + menuName);
      console.log("가격: " + cleanMoney);
      Swal.fire({
        title: "메뉴를 추가하시겠습니까?",
        imageUrl: "/images/menu/cafe/logo_.png",
        imageWidth: 400,
        imageHeight: 200,
        imageAlt: "Custom image",
        confirmButtonText: "추가",
      }).then((result) => {
        if (result.value) {
          let str = `
              <div class="order_div ${menuName}_menu d-flex align-center justify-content-between pt-3 mb-2">
                <div class="d-flex align-center justify-content-center">
                  <div class="name me-4 d-flex align-items-center">${menuName}</div>
                  <div>
                    <input
                      min="1"
                      style="width: 70px; height: 40px"
                      type="number"
                      value="1"
                      class="p-1 text-sm text-center count"
                    />
                  </div>
                </div>
                <div class="d-flex"></div>
                <div class="d-flex align-items-center money">
                  <div class="me-1" data-price="${cleanMoney}">${addComma(
            cleanMoney * 1
          )}</div> 원
                </div>
                <div class="order_delete_btn">
                  <i class="fa-solid fa-xmark"></i>
                </div>
              </div>
            `;
          if ($(".order_div").hasClass(`${menuName}_menu`)) {
            Swal.fire("이미 추가된상품입니다!", "", "warning");
          } else {
            $(".order_wrap").append(str);
          }
          updateTotalPrice();
          adjustMarginBottom();
        }
      });

      // 예: 선택한 데이터를 처리하는 코드 추가
      // alert("메뉴: " + menuName + "\n가격: " + cleanMoney + "원");
    });

    //콤마함수
    function addComma(number) {
      return number.toLocaleString(); // 자동으로 천 단위마다 콤마 추가
    }

    //높이 계산 후 margin-bottom 주는 함수
    function adjustMarginBottom() {
      var orderList = document.querySelector(".order_list");
      var mainContainer = document.querySelector(".main_container");

      // order_list의 높이를 구함
      var orderListHeight = orderList.offsetHeight;

      // main_container에 order_list 높이만큼 margin-bottom 적용
      mainContainer.style.marginBottom = orderListHeight + "px";

      // window.scrollTo(0, document.body.scrollHeight);
    }

    $(document).on("click", ".order_delete_btn", function () {
      $(this).closest(".order_div").remove();
      adjustMarginBottom();
      updateTotalPrice();
    });
    function updateTotalPrice() {
      let totalPrice = 0;
      $(".order_div").each(function () {
        // const count = $(this).find(".count").val();
        const money = $(this).find(".money").text().replace(/,/g, ""); // Remove commas for conversion
        totalPrice += parseFloat(money);
      });
      $(".total_price ").html(totalPrice.toLocaleString());
    }

    $(document).on("input", ".count", function () {
      let percent = $(this).closest(".onrdeR_div");
    });

    $(document).on("input", ".count", function () {
      let parent = $(this).closest(".order_div");
      let money = $(parent).find(".money > div").attr("data-price") * 1;

      let totalPrice = money * $(this).val();

      $(parent).find(".money > div").text(addComma(totalPrice));

      updateTotalPrice(); // Update total price when count changes
    });

    let orderArr = [];

    let menuNumber = 0;
    $(document).on("click", ".order_btn", function () {
      Swal.fire({
        title: "주문하시겠습니까?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "주문",
        cancelButtonText: "취소",
      }).then((result) => {
        if (result.isConfirmed) {
          if ($(".order_div").find(".name").text()) {
            $(".order_div").each(function () {
              const name = $(this).find(".name").text();
              const count = $(this).find(".count").val();
              const money = $(this).find(".money > div").attr("data-price") * 1; // Remove commas for conversion

              let obj = {
                name: name,
                count: count,
                money: money,
                number: menuNumber,
                complete: false,
              };
              orderArr.push(obj);
            });

            sendMenu();
          } else {
            Swal.fire({
              title: "선택된 메뉴가 없습니다",
              icon: "warning",
            });
          }
        }
      });
    });

    const orderRef = ref(database, typeValue);

    // 데이터 가져오기
    get(orderRef)
      .then((snapshot) => {
        if (snapshot.exists()) {
          const ordersData = snapshot.val();

          console.log("cc", ordersData.length);

          const numberOfOrders = Object.keys(ordersData).length; // 데이터의 개수를 셈
          console.log(`Number of orders: ${numberOfOrders}`);
          menuNumber = numberOfOrders * 1 + 1;

          if (menuNumber <= 0) {
            menuNumber = 1;
          }
        } else {
          console.log("No orders found.");
          menuNumber = 1;
          console.log("cc", menuNumber);
        }
      })
      .catch((error) => {
        console.error("Error fetching data:", error);
      });

    function sendMenu() {
      const orderData = orderArr;
      const orderRef = ref(database, typeValue);

      const newOrderRef = push(orderRef); // 새로운 주문을 추가

      set(newOrderRef, orderData)
        .then(() => {
          Swal.fire({
            title: "주문이 완료되었습니다.",
            html: `<div>감사합니다~! <br> 주문번호는 <strong>${menuNumber}</strong>번 입니다</div>`,
            icon: "success",
            confirmButtonText: "확인",
          }).then((result) => {
            if (result.isConfirmed) {
              // 확인 버튼이 눌렸을 때 페이지 새로고침
              location.reload();
            }
          });
        })
        .catch((error) => {
          console.error("주문 저장 실패: ", error);
          alert("주문 저장에 실패했습니다. 다시 시도해주세요.");
        });
    }
    $(document).on("click", ".menu_tab_click", function () {
      let type = $(this).data('type');
      cafeMenu = type;
      console.log(cafeMenu);
      draMenu();
    })
  </script>
</html>
