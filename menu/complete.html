<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>~</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link
      href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js"
      integrity="sha512-1/RvZTcCDEUjY/CypiMz+iqqtaoQfAITmNSJY17Myp4Ms5mdxPS5UV7iOfdZoxcGhzFbOm6sntTKJppjvuhg4g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Black+And+White+Picture&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css"
      integrity="sha512-SbiR/eusphKoMVVXysTKG/7VseWii+Y3FdHrt0EpKgpToZeemhqHeZeLWLhJutz/2ut2Vw1uQEj2MbRF+TVBUA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link href="/css/styles.css" rel="stylesheet" />
    <link href="/css/project.css" rel="stylesheet" />
    <link href="/css/order.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css"
    />
    <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    <!-- D3.js와 C3.js 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js"></script>
  </head>

  <style>
    .c3-legend {
      margin-top: 20px; /* 범례와 차트 사이의 간격 조정 */
    }
  </style>
  <body class="main_div">
    <!-- End footer -->

    <div class="container main_container">
      <div class="coffee_logo text-center mb-3">누적 판매</div>

      <div class="liq_order"></div>

      <div class="order_list">
        <div class="container row" style="max-width: 950px">
          <div class="order_wrap"></div>
          <div
            class="btn_wrap my-2 d-flex align-items-center justify-content-end px-0"
          >
            <div class="me-3">
              누적 판매금액:<span class="total_price ms-2">0</span>원
            </div>
          </div>
        </div>
      </div>

      <div class="ct-chart"></div>
      <div class="ct-chart-time"></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/scripts.min.js"></script>

    <link
      rel="stylesheet"
      type="text/css"
      href="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.css"
      integrity="sha512-6lLUdeQ5uheMFbWm3CP271l14RsX1xtx+J5x2yeIDkkiBpeVTNhTqijME7GgRKKi6hCqovwCoBTlRBEC20M8Mg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <script
      type="text/javascript"
      src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"
    ></script>
    <script src="js/project.js"></script>
  </body>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";
    import {
      getDatabase,
      ref,
      get,
      set,
      onValue,
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDg0M1zak7ZdIBp6uoFgiSwlyfdXoo5zvk",
      authDomain: "menu-5ecc1.firebaseapp.com",
      projectId: "menu-5ecc1",
      storageBucket: "menu-5ecc1.appspot.com",
      messagingSenderId: "411891444872",
      appId: "1:411891444872:web:d3bc08ce89d89ee3ee433d",
      measurementId: "G-9KG4DS84TQ",
      databaseURL: "https://menu-5ecc1-default-rtdb.firebaseio.com/",
    };

    let urlParams = new URLSearchParams(window.location.search);

    // 각 파라미터 값 가져오기
    let typeValue = urlParams.get("type"); //type

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    // Initialize Realtime Database and get a reference to the service
    const database = getDatabase(app);
    const menuRef = ref(database, typeValue);

    // 기존 차트의 labels 배열
    let labels = [];

    // 현재 URL의 쿼리 파라미터 가져오기
    onValue(menuRef, (snapshot) => {
      let sellPrice = 0;
      const data = snapshot.val();
      const countsByTime = {}; // 시간별로 각 상품 이름의 카운트를 저장할 객체
      const counts = {}; // 각 상품 이름별 카운트를 저장할 객체
      if (data) {
        // 주문 ID에 해당하는 모든 데이터를 순회
        for (const orderId in data) {
          if (data.hasOwnProperty(orderId)) {
            console.log("orderId", orderId);

            const orderItems = data[orderId]; // 각각의 주문 데이터 (배열)
            let tDstr = ``;
            let isComplete = false; // 모든 항목의 완료 상태를 확인하는 변수

            // 각 주문 아이템을 순회하며 출력
            orderItems.forEach((orderItem) => {
              console.log("orderItem", orderItem);

              if (!labels.includes(orderItem.name)) {
                labels.push(orderItem.name);
                counts[orderItem.name] = 0; // 새 항목일 경우 카운트 초기화
              }

              // 해당 name의 count를 누적
              counts[orderItem.name] += orderItem.count * 1; // 숫자 형식으로 계산

              const time = orderItem.time.split(" ")[1].slice(0, 5); // "HH:mm" 형식으로 시간 추출
              const name = orderItem.name;

              // 시간대별로 데이터를 초기화
              if (!countsByTime[time]) {
                countsByTime[time] = {};
              }
              if (!countsByTime[time][name]) {
                countsByTime[time][name] = 0;
              }

              // 해당 시간대의 해당 음료의 count를 누적
              countsByTime[time][name] += orderItem.count * 1; // 숫자 형식으로 계산

              // 만약 하나라도 complete가 true라면 해당 주문을 처리하지 않음
              if (orderItem.complete) {
                isComplete = true;
                sellPrice += orderItem.money * orderItem.count;
              }

              tDstr += `
                <tr>
                    <td class="text-center h-100 align-middle">${name}</td>
                    <td class="text-center align-middle">${orderItem.count}</td>
                    <td class="text-center align-middle">${orderItem.money}</td>
                    <td class="text-center align-middle">${
                      orderItem.money * 1 * orderItem.count * 1
                    }</td>
                </tr>
              `;
            });

            // 모든 아이템이 완료되지 않았을 때만 HTML을 추가
            if (isComplete) {
              let str = `
                <div class="text-center mb-3">
                  주문번호 : <span class="order-num">${orderItems[0].number}</span>
                  <table class="table">
                      <thead>
                          <tr>
                            <td class="text-center">상품명</td>
                            <td class="text-center">수량</td>
                            <td class="text-center">가격</td>
                            <td class="text-center">총금액</td>
                          </tr>
                      </thead>
                      <tbody>
                          ${tDstr}
                      </tbody>
                  </table>
              </div>
              `;
              $(".liq_order").append(str);
              $(".total_price").html(addComma(sellPrice));
            }
          }
        }

        // C3.js에 사용할 데이터 형식으로 변환
        const columns = [];
        const productNames = new Set();

        // 시간별 데이터를 C3.js에서 사용할 수 있도록 변환
        Object.keys(countsByTime).forEach((time) => {
          Object.keys(countsByTime[time]).forEach((name) => {
            productNames.add(name);
          });
        });

        productNames.forEach((name) => {
          const column = [name];
          Object.keys(countsByTime).forEach((time) => {
            column.push(countsByTime[time][name] || 0); // 해당 시간에 해당 상품이 없으면 0으로 설정
          });
          columns.push(column);
        });

        const times = ["x", ...Object.keys(countsByTime)]; // x 축 시간 목록

        // C3.js Chart 생성
        const chart = c3.generate({
          bindto: ".ct-chart-time",
          data: {
            x: "x",
            columns: [times, ...columns],
            type: "bar",
          },
          axis: {
            x: {
              type: "category",
            },
            y: {
              min: 1, // Y축의 최소값을 0으로 설정
              max:
                Math.ceil(
                  Math.max(...columns.map((col) => Math.max(...col.slice(1))))
                ) + 1, // Y축의 최대값을 최댓값+1로 설정
              tick: {
                format: function (value) {
                  return Math.floor(value); // 소수점을 제거하여 정수로 표시
                },
                count: Math.ceil(
                  Math.max(...columns.map((col) => Math.max(...col.slice(1)))) +
                    1
                ), // 최대값에 따라 눈금 수 설정
              },
            },
          },
          bar: {
            width: {
              ratio: 0.1, // 막대의 너비 조정
            },
          },
          padding: {
            top: 30,
          },
        });
        const series = labels.map((label) => counts[label] || 0);
        new Chartist.Bar(
          ".ct-chart",
          {
            labels: labels,
            series: series, // Chartist에서 시리즈는 배열 안에 배열 형태로 전달해야 함
          },
          {
            distributeSeries: true,
          }
        );
      } else {
        console.log("주문 데이터가 없습니다.");
      }
    });
    //콤마함수
    function addComma(number) {
      return number.toLocaleString(); // 자동으로 천 단위마다 콤마 추가
    }
  </script>
</html>
